<html>
    <head>
        <style type="text/css">
            * {
                box-sizing: border-box;
            }
            body {
                background-color: #222;
                margin: 0;
            }
            .mainContainer {
                display: flex;
                flex-direction: row;
            }
            .canvasContainer {
                flex: 1;
            }
            .settingsContainer {
                background-color: #444;
                color: white;
                display: flex;
                flex-direction: column;
                padding: 4px;
                width: 300px
            }
            .settingsRow {
                display: flex;
                flex-direction: row;
                margin-bottom: 4px;
                margin-top: 4px;
            }
            .settingsRow > input {
                flex: 1;
                margin-left: 4px;
                margin-right: 4px;
                min-width: 0;
            }
            #canvas {
                height: 100%;
                user-select: none;
                width: 100%;
            }
            #selection {
                border-color: red;
                border-style: solid;
                border-width: 1px;
                display: none;
                position: absolute;
            }
            .selectionButtons {
                bottom: 40px;
                display: flex;
                flex-direction: row;
                height: 40px;
                left: 0;
                position: relative;
                right: 0;
            }
            .selectionButtons > input {
                flex: 1
            }
        </style>
    </head>
    <body>
        <div class="mainContainer">
            <div class="canvasContainer">
                <canvas id="canvas"></canvas>
            </div>
            <form name="settingsForm" class="settingsContainer" onsubmit="onClickRender()">
                <div class="settingsRow">
                    <label>Xmin:</label>
                    <input id="XMin" value="-2.5" type="number" step="0.05">
                    <label>Xmax:</label>
                    <input id="XMax" value="1.5" type="number" step="0.05">
                </div>
                <div class="settingsRow">
                    <label>Ymin:</label>
                    <input id="YMin" value="-1.25" type="number" step="0.05">
                    <label>Ymax:</label>
                    <input id="YMax" value="1.25" type="number" step="0.05">
                </div>
                <div class="settingsRow">
                    <label>Max Iterations:</label>
                    <input id="MaxIterations" value="100" type="number" step="1">
                </div>
                <div class="settingsRow">
                    <input type="button" value="RENDER" onclick="onClickRender()">
                </div>
            </form>
        </div>
        <div id="selection">
            <div class="selectionButtons">
                <input type="button" value="Zoom" onclick="OnZoom()">
                <input type="button" value="Cancel" onclick="OnCancelZoom()">
            </div>
        </div>
        
        <script src="mandelbrot.js" type="text/javascript"></script>
        <script type="text/javascript">
            const getIntInput = (name) =>
                Number.parseFloat(document.forms['settingsForm'][name].value);

            const setIntInput = (name, value) =>
                document.forms['settingsForm'][name].value = value.toString();

            function getParameters() {
                return {
                    bounds: {
                        xMin: getIntInput('XMin'),
                        xMax: getIntInput('XMax'),
                        yMin: getIntInput('YMin'),
                        yMax: getIntInput('YMax'),
                    },
                    maxIterations: getIntInput('MaxIterations')
                };
            }

            function onClickRender() {
                const parameters = {
                    bounds: {
                        xMin: getIntInput('XMin'),
                        xMax: getIntInput('XMax'),
                        yMin: getIntInput('YMin'),
                        yMax: getIntInput('YMax'),
                    },
                    maxIterations: getIntInput('MaxIterations')
                };

                drawMandelbrot('.canvasContainer', parameters);
            }

            const canvas = document.getElementById('canvas');

            let isSelecting = false;
            let startX, startY, endX, endY;

            function updateSelection() {
                const selectionElement = document.getElementById('selection');
                selectionElement.style.display = 'block';
                selectionElement.style.left = Math.min(startX, endX);
                selectionElement.style.top = Math.min(startY, endY);
                selectionElement.style.width = Math.max(startX, endX) - Math.min(startX, endX);
                selectionElement.style.height = Math.max(startY, endY) - Math.min(startY, endY);
            }

            canvas.addEventListener('pointerdown', e => {
                canvas.setPointerCapture(e.pointerId);

                isSelecting = true;
                startX = e.offsetX;
                startY = e.offsetY;
                endX = startX;
                endY = startY;
            });
            canvas.addEventListener('pointermove', e => {
                if (!isSelecting) {
                    return;
                }

                endX = e.offsetX;
                endY = e.offsetY;
                updateSelection()
            });
            canvas.addEventListener('pointerup', e => {
                canvas.releasePointerCapture(e.pointerId);
                isSelecting = false;

                console.log({ startX, startY, endX, endY });
            });

            function OnZoom() {
                const p = getParameters();
                const xMin = lerp(p.bounds.xMin, p.bounds.xMax, Math.min(startX, endX) / canvas.width);
                const xMax = lerp(p.bounds.xMin, p.bounds.xMax, Math.max(startX, endX) / canvas.width);
                const yMin = lerp(p.bounds.yMin, p.bounds.yMax, Math.min(startY, endY) / canvas.height);
                const yMax = lerp(p.bounds.yMin, p.bounds.yMax, Math.max(startY, endY) / canvas.height);

                setIntInput('XMin', xMin);
                setIntInput('XMax', xMax);
                setIntInput('YMin', yMin);
                setIntInput('YMax', yMax);
            }

            function OnCancelZoom() {
                const selectionElement = document.getElementById('selection');
                selectionElement.style.display = 'none';
            }
        </script>
    </body>
</html>